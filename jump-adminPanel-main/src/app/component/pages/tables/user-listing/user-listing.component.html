<div class="row">
  <div class="col-xl-12">
    <app-card [options]="false" blockClass="table-border-style">
      <div class="d-flex justify-content-end pb-2">
        <div class="mx-3">
          <form [formGroup]="searchUser">
            <input
              id="searchQueryInput"
              type="text"
              name="search"
              formControlName="userName"
              placeholder="Search"
              value=""
              tbSingleSpace
            />
            <button
              id="searchQuerySubmit"
              type="submit"
              name="searchQuerySubmit"
              (click)="clearSearchForm()"
              *ngIf="searchUser.get('userName').value !== ''"
            >
              <i class="feather icon-x"></i>
            </button>
          </form>
        </div>
        <button
          type="button"
          class="btn shadow-1 btn-sm"
          style="background-color: #333f54; color: white"
          (click)="downloadUsersAsCSV()"
        >
          <i class="feather icon-download"></i>
          Export
        </button>

        <button
          type="button"
          class="btn shadow-1 btn-sm"
          style="background-color: #333f54; color: white"
          (click)="openAddUserModal()"
        >
          <i class="feather icon-user-plus"></i>
          Add User
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped user-table">
          <thead class="table">
            <tr>
              <th scope="col">S.no</th>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Company</th>
              <th>Position</th>
              <th>Action</th>
            </tr>
          </thead>
          @if (!NoDataFound) {
            <tbody>
              <tr *ngFor="let user of allUsers; index as i" class="userRow">
                <th class="sNo" scope="row">{{ i + 1 }}</th>
                <td>{{ user?.firstName }} {{ user?.lastName }}</td>
                <td>{{ user?.email }}</td>
                <td>{{ user?.company }}</td>
                <td>{{ user?.positions }}</td>
                <td>
                  <app-action-icons
                    [onEdit]="editUser.bind(this, user)"
                    [onDelete]="deleteUser.bind(this, user.id, user.roles)"
                    [onView]="viewUser.bind(this, user)"
                  >
                    ></app-action-icons
                  >
                </td>
              </tr>
            </tbody>
          }
        </table>
        <!-- PAGINATOR -->
        <div class="d-flex justify-content-end mx-2">
          @if (allUsers) {
            <app-paginator
              [totalPage]="totalPage"
              [currentPage]="currentPage"
              (pageChange)="goToPage($event)"
            ></app-paginator>
          }
        </div>
      </div>

      <div>
        @if (!allUsers) {
          <app-nodata-found></app-nodata-found>
        }
      </div>
    </app-card>
  </div>
</div>

<!-- ADD USER MODAL -->
<ng-template #addUserModal let-modal>
  <div class="modal-header" style="background-color: #333f54">
    <h4 class="modal-title text-white">
      {{ isEditMode ? "Edit User" : "Add New User" }}
    </h4>
  </div>
  <form [formGroup]="addUserForm" (ngSubmit)="saveUser()">
    <div class="modal-body">
      <div class="row">
        <div class="col-md-6" *ngFor="let field of formFields">
          <ng-container
            *ngIf="
              !isEditMode ||
              (isEditMode &&
                field.controlName !== 'email' &&
                field.controlName !== 'password')
            "
          >
            <div class="mb-3">
              <div class="form-group">
                <label for="text">{{ field.label }}</label>
                <input
                  type="text"
                  autocomplete="off"
                  class="form-control"
                  [required]="field.required"
                  [formControlName]="field.controlName"
                  [placeholder]="field.placeholder"
                  [type]="field.type"
                  tbSingleSpace
                />
              </div>
              @if (
                addUserForm.get(field.controlName)?.hasError("required") &&
                (formSubmitted ||
                  addUserForm.get(field.controlName).touched ||
                  addUserForm.get(field.controlName).dirty)
              ) {
                <small class="error">
                  {{ field.errorMsg }}
                </small>
              }

              <div >
                @if (
                  field.controlName === "email" &&
                  addUserForm.get("email").invalid &&
                  addUserForm.get("email").touched
                ) {
                  <small class="error">{{ getEmailErrorMessage() }}</small>
                }
              </div>
              <div >
                @if (
                  field.controlName === "password" &&
                  addUserForm.get("password").invalid &&
                  addUserForm.get("password").touched
                ) {
                  <small class="error">{{ getPasswordErrorMessage() }}</small>
                }
              </div>
            </div>
          </ng-container>
        </div>

        <div class="col-md-12">
          <div class="form-group">
            <label for="exampleFormControlTextarea1">About</label>
            <textarea
              class="form-control"
              id="exampleFormControlTextarea1"
              rows="3"
              formControlName="aboutMe"
              required=""
              maxlength="200"
              tbSingleSpace
            ></textarea>
          </div>
          @if (
            addUserForm.get("aboutMe")?.hasError("required") &&
            (formSubmitted ||
              addUserForm.get("aboutMe").touched ||
              addUserForm.get("aboutMe").dirty)
          ) {
            <small class="error">About is required</small>
          }
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn shadow-1 btn-sm"
        (click)="closeMoadal()"
        style="background-color: rgb(194, 49, 49); color: white"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="btn shadow-1 btn-sm"
        style="background-color: #333f54; color: white"
      >
        {{ isEditMode ? "Update" : "Save" }}
      </button>
    </div>
  </form>
</ng-template>

<!-- VIEW PROFILE MODAL -->
<ng-template #ProfileModal let-modal>
  <div
    class="modal-header d-flex justify-content-between"
    style="background-color: #333f54"
  >
    <h4 class="modal-title text-white">User Profile</h4>
    <span class="icon-parent" (click)="closeMoadal()">
      <i
        class="feather icon-x cancel-icon"
        style="color: white; cursor: pointer"
      ></i>
    </span>
  </div>
  <div>
    <div class="container">
      <div class="main-body">
        <div class="row">
          <div class="col-md-12 my-2">
            <div class="card">
              <div class="card-body">
                <div
                  class="example-button-container d-flex justify-content-end"
                ></div>
                <div class="d-flex flex-column align-items-center text-center">
                  <div *ngIf="userProfile">
                    <div
                      *ngIf="userProfile?.profile_pic"
                      class="span-image"
                      id="image-container"
                    >
                      <img
                        [src]="apiUrl + userProfile?.profile_pic"
                        alt="Admin"
                      />
                    </div>
                    <span
                      *ngIf="userProfile?.profile_pic == null"
                      class="avatar-container"
                    >
                      {{ userProfile.firstName[0] | uppercase
                      }}{{ userProfile.lastName[0] | uppercase }}
                    </span>
                  </div>

                  <div class="mt-3" *ngIf="userProfile">
                    <h4>
                      {{ userProfile.firstName | uppercase }}
                      {{ userProfile.lastName | uppercase }}
                    </h4>
                    <h5 class="text-info text-capitalize fw-bold mb-0">
                      {{ userProfile.positions }}
                    </h5>
                    <p class="text-muted mt-1 font-size-sm">
                      {{ userProfile.aboutMe }}
                    </p>
                  </div>
                </div>
                <div class="row mt-3 userInfo" *ngIf="userProfile">
                  <table class="profile_table">
                    <tr>
                      <th [width]="100"><h5>Email :</h5></th>
                      <td>
                        <h5>{{ userProfile.email }}</h5>
                      </td>
                    </tr>
                    <tr>
                      <th [width]="100"><h5>Status :</h5></th>
                      <td
                        class="badge custom-badge"
                        [style.backgroundColor]="
                          userProfile.status === 'Active' ? 'green' : 'red'
                        "
                      >
                        {{ userProfile.status }}
                      </td>
                    </tr>
                    <tr>
                      <th [width]="100"><h5>Verified :</h5></th>
                      <td
                        class=" custom-badge"
                        [style.color]="
                          userProfile.isVerified === true ? 'green' : 'red'
                        "
                      >
                        {{
                          userProfile.isVerified
                            ? "✔️ Verified"
                            : "❌ Not Verified "
                        }}
                      </td>
                    </tr>
                    <tr>
                      <th [width]="150"><h5>Preferences :</h5></th>
                      <td class="preferences">
                        <span
                          *ngFor="
                            let compList of userProfile.comprensive_listings;
                            index as i
                          "
                        >
                          <span
                            class="badge custom-badge mx-1"
                            [ngClass]="getColorClass(i)"
                            >{{ compList.name }}
                          </span>
                        </span>

                        <span
                          *ngIf="userProfile.comprensive_listings?.length == 0"
                          >No Preferences
                        </span>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>
